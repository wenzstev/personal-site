<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>More Changes to the Lines... And Thoughts About Perfectionism</title>
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="full-page">
    <div class="content">
    <header>
  <div class="blog-container">
  <div class="blog-header">
      <h2>More Changes to the Lines... And Thoughts About Perfectionism</h2>
      <small>17 Apr 2020</small>
  </div>
  </div>
</header>


<div class="post">
<p>This wasn’t quite the blog post that I wanted to make. After having written up the changes to the recipe adder screen, I had turned my attention to the list page, wanting to clean up a number of built-but-rickety features and give the page a much-needed tune-up. One thing that I’d realized in the process of revamping the recipe adder page was that my understanding of CSS and how to lay out a webpage had grown by leaps and bounds since I first started, and I was eager to apply those same principles to the main list page. I figured that I would work on this for a few days, then come out with a long post about all the different things I’d changed, and then gear up for some final bug fixes for the final release.</p>

<p>But this post isn’t quite that post. That post is still coming; it’s halfway written and currently sitting pretty in my “drafts” folder. But it’s not this post, because partway through my work on the list page, I realized that my implementation of marking out ingredients on the recipe lines had several notable issues, and my attempts to fix those issues forced me to rewrite more of the code base than I’d expected, and I think may have driven home an important lesson about perfectionism.</p>

<p>But first, the scene.</p>

<h3 id="a-hiccup-in-the-cleaned-lines">A Hiccup in the Cleaned Lines</h3>

<p>My changes to the list page started out well enough. I’ll save most of the description on what that’s going to look like for my next post, but suffice to say that I’ve been giving it a slick upgrade (that may or may not be heavily inspired by Trello’s UI), and cutting out <em>a lot</em> of my tangled mass of HTML that was there before. The new page is simpler, more elegant, and I like it a lot.</p>

<p>However, in the process of implementing the inline edits to the recipe lines, I realized that my solution to having multiple ingredients in the same line did not allow for two adjacent ingredients to be selected. This was in fact baked into its design; all my too-clever-by-half code to create and join up the button groups that I’d spent so much time on last week actually inhibited my ability to implement this feature, since clicking on a word next to an ingredient group automatically added that word to the ingredient in question. Worse, this was complicated further by my desire to have inline edits to recipe lines, to allow a user to modify the ingredients in real time without having to return to the recipe adder page. I wanted to have the <code class="language-plaintext highlighter-rouge">CleanedLine</code> objects automatically split and recombine as necessary, but this was made much harder by the fact that combining and splitting lines felt much more cumbersome than I was expecting. More generally, I just didn’t like how there was this hole in functionality; my brain immediately went to all the cases where an end user would try to add an adjacent ingredient, become frustrated with the process, and declare the app (and by extension, me) an utter failure.</p>

<p>No, this would not do at all. I decided that, before I continued work on the final list page revisions, I would need to modify my code to support adjacent ingredients. <em>This,</em> I told myself, would be the final changes to the recipe page functionality–then I could put it to bed for good.</p>

<p>My new concept for the ingredient lines involved different colored button groups, one for each ingredient. The user would be able to select which color they wanted to “paint” with, and then click/tap on the words to mark them as that color. All words of that color would then be considered part of one ingredient. On the list page, clicking on a line to edit would only show the ingredient associated with that line, and could then be easily edited without worrying about any other ingredients on the line.</p>

<p>There were a few issues with this approach that I wasn’t quite sure how to solve, but I decided to plow forward regardless, thinking that they would resolve themselves in time. And they did, for the most part, just not in the way that I was expecting.</p>

<h3 id="the-code">The Code</h3>

<p>First up, it was back to the recipe adder page. My goal here was to have a small toolbar that contained different colors to paint the lines with. The toolbar would scroll with the user and would stick at a certain point when the user scrolled high enough. I used the <code class="language-plaintext highlighter-rouge">card</code> class and the grid layout to construct a simple bar with three colors on it:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"ingredient-selector"</span> <span class="na">class=</span><span class="s">"p-2 mx-1 bg-info rounded align-middle row"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"color-instructions col-auto text-light"</span><span class="nt">&gt;</span>Ingredient selector: <span class="nt">&lt;/span&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"color-label mr-1 form-check-inline col-auto"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"radio"</span> <span class="na">name=</span><span class="s">"color"</span> <span class="na">value=</span><span class="s">"ing-1"</span> <span class="na">checked</span><span class="nt">&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"color-radio shadow-sm"</span> <span class="na">style=</span><span class="s">"background: coral"</span><span class="nt">&gt;&lt;/span&gt;</span>
            <span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"color-label mr-1 form-check-inline col-auto"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"radio"</span> <span class="na">name=</span><span class="s">"color"</span> <span class="na">value=</span><span class="s">"ing-2"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"color-radio shadow-sm"</span> <span class="na">style=</span><span class="s">"background: darkorchid"</span><span class="nt">&gt;&lt;/span&gt;</span>
            <span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">"color-label mr-1 form-check-inline col-auto"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"radio"</span> <span class="na">name=</span><span class="s">"color"</span> <span class="na">value=</span><span class="s">"ing-3"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"color-radio shadow-sm"</span> <span class="na">style=</span><span class="s">"background: forestgreen"</span><span class="nt">&gt;&lt;/span&gt;</span>
            <span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;/div&gt;</span></code></pre></figure>

<p>This created a simple, functional toolbar:</p>

<p><img src="/assets/img/posts/multiple-ingredients/selector-bar.png" alt="alt text" /></p>

<p>Then, I added some javascript that would check the user’s scroll position, and add a new class,  <code class="language-plaintext highlighter-rouge">sticky</code>, that kept the scrollbar in position.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#ingredient-selector</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>


<span class="nx">$</span><span class="p">(</span> <span class="nb">window</span> <span class="p">).</span><span class="nx">scroll</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">win_offset</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span> <span class="nb">window</span> <span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">win_offset</span> <span class="o">&gt;=</span> <span class="nx">offset</span><span class="p">){</span>
    <span class="nx">selector</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="dl">"</span><span class="s2">sticky</span><span class="dl">"</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">selector</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="dl">"</span><span class="s2">sticky</span><span class="dl">"</span><span class="p">)</span>
  <span class="p">}</span>

<span class="p">})</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">sticky</code> class was just a few lines to set the position to fixed and make sure it stayed in the right place and rendered above everything else.</p>

<figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nc">.sticky</span> <span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">fixed</span><span class="p">;</span>
  <span class="nl">top</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="nl">z-index</span><span class="p">:</span> <span class="m">5</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>This worked pretty well, but my next task was much harder: the buttons had to actually <em>do</em> something. I started by creating three new classes, named <code class="language-plaintext highlighter-rouge">ing-</code> 1 through 3, and gave them the same colors as the buttons.</p>

<figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nc">.ing-1</span> <span class="p">{</span>
  <span class="nl">background-color</span><span class="p">:</span> <span class="no">coral</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.ing-2</span> <span class="p">{</span>
  <span class="nl">background-color</span><span class="p">:</span> <span class="no">darkorchid</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.ing-3</span> <span class="p">{</span>
  <span class="nl">background-color</span><span class="p">:</span> <span class="no">forestgreen</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>I then rewrote the <code class="language-plaintext highlighter-rouge">btn-ingredient</code> class to function as a sort of “universal” class for all three ingredient types. I figured this would work because the program would still need to distinguish between ingredient words and regular words, and I liked the rounded corners styling that I’d incorporated.</p>

<figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nc">.btn-ingredient</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="no">white</span><span class="p">;</span>
  <span class="nl">font-style</span><span class="p">:</span> <span class="nb">normal</span><span class="p">;</span>
  <span class="nl">cursor</span><span class="p">:</span> <span class="nb">pointer</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.btn-ingredient</span><span class="nd">:first-child</span><span class="p">{</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">10px</span> <span class="m">0px</span> <span class="m">0px</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.btn-ingredient</span><span class="nd">:last-child</span><span class="p">{</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">0px</span> <span class="m">10px</span> <span class="m">10px</span> <span class="m">0px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.btn-ingredient</span><span class="nd">:only-child</span><span class="p">{</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Of course, the next problem was that, because all the different ingredients still had the <code class="language-plaintext highlighter-rouge">btn-ingredient</code> class, the function I’d written to create the button groups bunched them all together. So I had to go through and rewrite <em>that</em> as well. At the same time, I snuck in a bit of refactoring; changing the function so that it changed only a single line, rather than looping through all the <code class="language-plaintext highlighter-rouge">rawline</code> classes. I did this to make it easier to use on my list page.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">create_ingredient_groups</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">current_group</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">button_group</span><span class="p">)</span> <span class="c1">// create button group div</span>
    <span class="nx">current_line</span> <span class="o">=</span> <span class="nx">line</span>
    <span class="kd">var</span> <span class="nx">cur_group_color</span> <span class="o">=</span> <span class="dl">""</span>
    <span class="nx">line</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">next</span><span class="p">()</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span> <span class="k">this</span> <span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="dl">'</span><span class="s1">btn-ingredient</span><span class="dl">'</span><span class="p">)){</span>
        <span class="kd">var</span> <span class="nx">button_reg</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span> <span class="k">this</span> <span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="nx">ing_reg</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">button_reg</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">button_color</span> <span class="o">=</span> <span class="nx">button_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">button_color</span> <span class="o">==</span> <span class="nx">cur_group_color</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// still in same group</span>
            <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">current_group</span><span class="p">)</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">current_group</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
                <span class="c1">// new button group, insert old and reset</span>
                <span class="nx">current_group</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
                <span class="nx">cur_group_color</span> <span class="o">=</span> <span class="nx">button_color</span>
                <span class="nx">current_group</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">button_group</span><span class="p">)</span>
                <span class="nx">current_group</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// first button of new group</span>
                <span class="nx">current_group</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
                <span class="nx">cur_group_color</span> <span class="o">=</span> <span class="nx">button_color</span>
              <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span> <span class="c1">// end of line</span>
          <span class="nx">current_line</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">current_group</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">current_group</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="c1">// end of button group, insert into line</span>
        <span class="nx">current_group</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
        <span class="nx">current_group</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">button_group</span><span class="p">)</span> <span class="c1">// reset group</span>
      <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span></code></pre></figure>

<p>This took a while, and there was a lot of scratching my head and trying to figure out what was wrong when buttons suddenly had all their classes stripped or were inserted in wacky places. But there was a silver lining to it: I had been dreading the <em>other</em> broken function in all of this, <code class="language-plaintext highlighter-rouge">update_ingredient_groups()</code> function that changed what buttons were inside and outside of the group. This one would have gotten considerably more complicated with the addition of multiple new button groups, but I realized that I didn’t actually need it at all. Now that my <code class="language-plaintext highlighter-rouge">create_ingredient_groups()</code> function worked on a line-by-line basis, all I needed to do was strip away the old ingredient groups and run it again to update the line. And that’s exactly what I did:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">strip_groups</span><span class="p">(</span><span class="nx">line</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
  <span class="nx">line</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="dl">"</span><span class="s2">.btn-group</span><span class="dl">"</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">children</span><span class="p">().</span><span class="nx">unwrap</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}</span></code></pre></figure>

<p>I could have done this before (and saved myself a lot of headache with the nearly-100 line function I’d built), but hey. You live and learn.</p>

<p>Next, however, was a still harder task: I needed to rewrite the code that actually parsed the recipe lines, meaning I would have to deal with spaCy for the first time in months. The problem was that my old code wasn’t equipped to differentiate between more than one ingredient. Parsing the lines could split the ingredients by detecting that there was a non-ingredient word in between then, but removing that word meant I could no longer rely on this. The <em>other</em> problem was that ingredient words now had two classes associated with them: the old <code class="language-plaintext highlighter-rouge">btn-ingredient</code> class, and a new one, identifying which ingredient they were a part of.</p>

<p>My solution was to create a new list, containing the three new classes. The function then checks if an entity is an ingredient, and if it is at the beginning of the ingredient entity (using the <a href="https://spacy.io/usage/linguistic-features#named-entities">IOB</a> scheme), looping through the ingredients as necessary.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">line_ingredients</span> <span class="o">=</span> <span class="p">[</span><span class="s">"ing-1"</span><span class="p">,</span> <span class="s">"ing-2"</span><span class="p">,</span> <span class="s">"ing-3"</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">color_entities_in_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">line_colors</span><span class="o">=</span><span class="n">line_colors</span><span class="p">):</span>
    <span class="n">cur_ingredient</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">in_ingredient</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">color_tuples</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list of tuples of token and the color
</span>    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">ent_iob_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">.</span><span class="n">ent_type_</span> <span class="o">==</span> <span class="s">"INGREDIENT"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="p">.</span><span class="n">ent_iob_</span> <span class="o">==</span> <span class="s">"B"</span><span class="p">:</span>
                <span class="n">cur_ingredient</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">cur_ingredient</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">color_tuples</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">.</span><span class="n">text</span><span class="p">,</span>  <span class="s">"btn-ingredient "</span> <span class="o">+</span> <span class="n">line_ingredients</span><span class="p">[</span><span class="n">cur_ingredient</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color_tuples</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">line_colors</span><span class="p">[</span><span class="s">"O"</span><span class="p">]))</span>


    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">color_tuples</span><span class="p">)</span></code></pre></figure>

<p>This also effectively meant that the tuples now had two classes associated with them, but I could split them up fairly easily.</p>

<p>Next, I had to rewrite the function that turned the raw line data into ingredients that the <code class="language-plaintext highlighter-rouge">CleanedLine</code>s could use. This function was more complicated, because it needed to deal with a situation where two adjacent ingredients were next to each other. Ultimately, I scrapped the old boolean test to see if a word was in an ingredient or not, and instead opted to hold the class of the current ingredient and compare it to the class of the word being checked.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># method that takes in json data from line colors and returns tuple of (amount, measurement, ingredient)
</span><span class="k">def</span> <span class="nf">extract_ingredients</span><span class="p">(</span><span class="n">color_string</span><span class="p">,</span>
                        <span class="n">ingredient_color</span><span class="o">=</span><span class="s">"text-success"</span><span class="p">,</span>
                        <span class="n">cardinal_color</span><span class="o">=</span><span class="s">"text-warning"</span><span class="p">,</span>
                        <span class="n">quantity_color</span><span class="o">=</span><span class="s">"text-primary"</span><span class="p">):</span>
    <span class="n">ingredients</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># list of ingredients in the line
</span>    <span class="n">measurement</span> <span class="o">=</span> <span class="s">''</span>    <span class="c1"># not currently used
</span>    <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1"># not currently used
</span>    <span class="n">color_dict</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">color_string</span><span class="p">)</span>
    <span class="n">current_ingredient</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">ingredient_class</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">classes</span> <span class="ow">in</span> <span class="n">color_dict</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">classes</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="c1"># check the length of the colors because otherwise removing a button from an ingredient will throw an error
</span>        <span class="k">if</span> <span class="n">line_colors</span><span class="p">[</span><span class="s">"INGREDIENT"</span><span class="p">]</span> <span class="ow">in</span> <span class="n">colors</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># we're in an ingredient
</span>            <span class="k">if</span> <span class="n">ingredient_class</span> <span class="o">==</span> <span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># we're already in the ingredient
</span>                <span class="n">current_ingredient</span> <span class="o">+=</span> <span class="n">word</span> <span class="o">+</span> <span class="s">' '</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c1"># new ingredient, check if coming from adjacent or not
</span>                <span class="k">if</span> <span class="ow">not</span> <span class="n">ingredient_class</span><span class="p">:</span>
                    <span class="c1"># we're starting an ingredient
</span>                    <span class="n">current_ingredient</span> <span class="o">+=</span> <span class="n">word</span> <span class="o">+</span> <span class="s">' '</span>
                    <span class="n">ingredient_class</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># new, adjacent ingredient
</span>                    <span class="n">current_ingredient</span> <span class="o">=</span> <span class="n">word</span> <span class="o">+</span> <span class="s">' '</span>
                    <span class="n">ingredient_class</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># not in ingredient
</span>            <span class="k">print</span><span class="p">(</span><span class="s">"length of current is "</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_ingredient</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_ingredient</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># we ended an ingredient, need to add it
</span>                <span class="n">current_ingredient</span> <span class="o">=</span> <span class="s">''</span>
                <span class="n">ingredient_class</span> <span class="o">=</span> <span class="s">''</span>  <span class="c1"># reset the class
</span>
    <span class="k">if</span> <span class="n">current_ingredient</span><span class="p">:</span>  <span class="c1"># end of line
</span>        <span class="n">ingredients</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_ingredient</span><span class="p">,</span> <span class="n">ingredient_class</span><span class="p">))</span>


    <span class="k">return</span> <span class="n">amount</span><span class="p">,</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">ingredients</span></code></pre></figure>

<p>I’m still not using amount and measurement, and should probably get rid of them at some point. But by now I was realizing that I had bitten off more than I could chew, and just needed to get to a point where my program worked again.</p>

<p>On to the actual parsing of the cleaned lines. I added two new attributes to my <code class="language-plaintext highlighter-rouge">CleanedLine</code> model. The first, <code class="language-plaintext highlighter-rouge">rawline_index</code>, was the index of the <code class="language-plaintext highlighter-rouge">CleanedLine</code>’s particular ingredient in the array that <code class="language-plaintext highlighter-rouge">extract_ingredients()</code> returned. The second, <code class="language-plaintext highlighter-rouge">ingredient_color</code>, was the class of the ingredient. I needed this when changing the ingredient on my line page.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">rlist_lines</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">text_to_colors</span><span class="p">)</span>
    <span class="n">amount</span><span class="p">,</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">ingredient_tuples</span> <span class="o">=</span> <span class="n">extract_ingredients</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">text_to_colors</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ingredient_tuples</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ingredient_tuples</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ingredient_tuples</span><span class="p">)</span>
        <span class="n">ingredient</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">ingredient_tuples</span>
        <span class="k">if</span> <span class="n">ingredient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ingredient_dict</span><span class="p">:</span>


            <span class="n">cleaned_line</span> <span class="o">=</span> <span class="n">CleanedLine</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
                                       <span class="n">measurement</span><span class="o">=</span><span class="n">measurement</span><span class="p">,</span>
                                       <span class="n">ingredient</span><span class="o">=</span><span class="n">ingredient</span><span class="p">,</span>
                                       <span class="nb">list</span><span class="o">=</span><span class="n">current_list</span><span class="p">,</span>
                                       <span class="n">index_in_list</span><span class="o">=</span><span class="n">current_list_length</span><span class="p">,</span>
                                       <span class="n">rawline_index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                                       <span class="n">ingredient_color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
            <span class="n">current_list_length</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># add one to get the new length of the list
</span>
            <span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">cleaned_line</span><span class="p">)</span>
            <span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">line</span><span class="p">.</span><span class="n">cleaned_lines</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned_line</span><span class="p">)</span>
            <span class="n">ingredient_dict</span><span class="p">[</span><span class="n">ingredient</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleaned_line</span>
            <span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span><span class="p">.</span><span class="n">cleaned_lines</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ingredient_dict</span><span class="p">[</span><span class="n">ingredient</span><span class="p">])</span></code></pre></figure>

<p>Why did I need this on my line page? Because I didn’t have the ingredient selector div there. I decided that including it (and, by implication, the opportunity to dynamically split lines) would introduce even more complication into what I was already realizing was an overly complicated process. So instead, I had each individual line contain knowledge of what color to use, and passed that value in when changing the ingredient.</p>

<p>Then, I had to write the code to modify the cleaned lines on the list page. I made use of the <code class="language-plaintext highlighter-rouge">rawline_index</code> attribute, and changed all the <code class="language-plaintext highlighter-rouge">CleanedLines</code> associated with the <code class="language-plaintext highlighter-rouge">RawLine</code> each time it was changed. This prevented overlap, which currently would not be supported (since the program has no way to differentiate between ingredients if there are two ingredient classes).</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">@</span><span class="n">line</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/line/set_color'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">set_color</span><span class="p">():</span>

    <span class="k">print</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">)</span>
    <span class="n">cur_line</span> <span class="o">=</span> <span class="n">RawLine</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">hex_id</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'rawline_id'</span><span class="p">,</span> <span class="s">''</span><span class="p">,</span> <span class="nb">str</span><span class="p">)).</span><span class="n">first_or_404</span><span class="p">()</span>

    <span class="c1"># get ingredients before changing so that we can compare (performance hit?)
</span>    <span class="n">amount</span><span class="p">,</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">old_ingredient_tuples</span> <span class="o">=</span> <span class="n">extract_ingredients</span><span class="p">(</span><span class="n">cur_line</span><span class="p">.</span><span class="n">text_to_colors</span><span class="p">)</span>

    <span class="n">new_colors</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'text_to_colors'</span><span class="p">,</span> <span class="s">''</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">cur_line</span><span class="p">.</span><span class="n">text_to_colors</span> <span class="o">=</span> <span class="n">new_colors</span>
    <span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">cur_line</span><span class="p">.</span><span class="n">text_to_colors</span><span class="p">)</span>

    <span class="c1"># check if we have a cleaned line as well
</span>    <span class="k">print</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'cleanedline_id'</span><span class="p">))</span>
    <span class="n">cline_to_change</span> <span class="o">=</span> <span class="n">CleanedLine</span><span class="p">.</span><span class="n">query</span><span class="p">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">hex_id</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'cleanedline_id'</span><span class="p">)).</span><span class="n">first</span><span class="p">()</span>
    <span class="n">clines_to_change</span> <span class="o">=</span> <span class="n">cur_line</span><span class="p">.</span><span class="n">cleaned_lines</span>
    <span class="k">if</span> <span class="n">clines_to_change</span><span class="p">:</span>
        <span class="n">amount</span><span class="p">,</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">ingredient_tuples</span> <span class="o">=</span> <span class="n">extract_ingredients</span><span class="p">(</span><span class="n">cur_line</span><span class="p">.</span><span class="n">text_to_colors</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cline</span><span class="p">,</span> <span class="n">tup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clines_to_change</span><span class="p">,</span> <span class="n">ingredient_tuples</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">cline</span><span class="p">,</span> <span class="n">tup</span><span class="p">)</span>
            <span class="n">cline</span><span class="p">.</span><span class="n">ingredient</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># change the ingredient to the new one
</span>        <span class="n">db</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">changed_lines</span> <span class="o">=</span> <span class="p">{</span><span class="n">cline</span><span class="p">.</span><span class="n">hex_id</span><span class="p">:</span> <span class="n">cline</span><span class="p">.</span><span class="n">ingredient</span> <span class="k">for</span> <span class="n">cline</span> <span class="ow">in</span> <span class="n">clines_to_change</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">changed_lines</span><span class="o">=</span><span class="n">changed_lines</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">new_colors</span><span class="p">)</span></code></pre></figure>

<p>Notice here that I returned the <code class="language-plaintext highlighter-rouge">hex_id</code> and new ingredient lines. I did this so that the client could automatically change the lines, rather than needing to refresh the page like it did before. The <code class="language-plaintext highlighter-rouge">send_line_data()</code> function can now check if there are <code class="language-plaintext highlighter-rouge">CleanedLine</code>s associated with the changed <code class="language-plaintext highlighter-rouge">RawLine</code> and update the data if so:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// check if we have a cleaned line and if so add it</span>
  <span class="nx">line_id</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span> <span class="nx">button</span> <span class="p">).</span><span class="nx">parents</span><span class="p">(</span><span class="dl">'</span><span class="s1">.full-line</span><span class="dl">'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">line_id</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">line_id</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="nx">data</span><span class="p">[</span><span class="dl">'</span><span class="s1">cleanedline_id</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">line_id</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">line_id</span><span class="p">)</span>

  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="nx">$SCRIPT_ROOT</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/line/set_color</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">data</span><span class="p">:</span> <span class="nx">data</span><span class="p">,</span>
    <span class="na">dataType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jsonData</span><span class="p">){</span>
      <span class="nx">strip_groups</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
      <span class="nx">create_ingredient_groups</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jsonData</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">jsonData</span><span class="p">[</span><span class="dl">'</span><span class="s1">changed_lines</span><span class="dl">'</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
        <span class="c1">// we have lines to change</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">changed_line</span> <span class="k">in</span> <span class="nx">jsonData</span><span class="p">[</span><span class="dl">'</span><span class="s1">changed_lines</span><span class="dl">'</span><span class="p">]){</span>
          <span class="c1">// iterate through and change the values</span>
          <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#line-</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">changed_line</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="dl">"</span><span class="s2">.ingredient-name</span><span class="dl">"</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">jsonData</span><span class="p">[</span><span class="dl">'</span><span class="s1">changed_lines</span><span class="dl">'</span><span class="p">][</span><span class="nx">changed_line</span><span class="p">])</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span></code></pre></figure>

<p>So, what was the result of this quixotic journey through all of my supposed-to-be-about-to-launch code?</p>

<p><img src="/assets/img/posts/multiple-ingredients/new-adjacent-ingredients.png" alt="alt text" /></p>

<p>There. You can now have multiple ingredients on the same line, and the ingredients can be adjacent to each other. Of course, “chopped red” is not an ingredient, but it still works as proof of concept. In a hypothetical situation where there were multiple ingredients right next to each other, the user could select them as separate ingredients without much hassle.</p>

<p>Only… how often will that happen? Sure, it might happen occasionally, but part of the point of having recipe <em>lines</em> is that there is generally only one ingredient on each line. This is something of an edge case, at best. An edge case that I spent over 10 hours adding, bending my brain in knots to make it work.</p>

<p>Now, don’t get me wrong, there are better ways to implement this, and I think working through this has made me a better programmer. But at the same time, I’m already a week past my deadline, and new features keep popping up and wanting to be added. What’s going on here?</p>

<p>Honestly, I think I’m nervous. I know that it will soon be time to show this to other people, and I’ve never done that before. My perfectionism is kicking into overdrive, and I’m grappling with the need to make it perfect before other people can see it, to make it as impressive as possible. But of course, such things are arbitrary. It will never be “perfect” because there will never be a time when <em>some</em> little aspect of it doesn’t keep bugging me.</p>

<p>And that’s a problem because I can envision a situation where little things keep popping up and demanding my attention, and I put off a release for a bit longer to fix this, then that, and all the while I’m getting a bit more burned out, and it’s a bit harder to boot up the program, and shiny new project ideas keep attracting more and more of my attention…</p>

<p>So I made a resolution. “Completeness” is somewhat arbitrary, right? Then I’m going to say version 1 is complete. I have a small list of bugs to fix, but dammit by the end of the weekend this program is going online. I can add post-release fixes later, but I am not going to let this gather dust.</p>

</div>

<footer>
  <div class="footer-spread">
  <span><a href="/index.html">Home</a></span>
  <span><a href="/blog">Blog</a></span>
  <span>Email: <a href="mailto:wenzelstev@gmail.com">wenzelstev@gmail.com</a></span>
  <span><a href="https://www.linkedin.com/in/steven-wenzel/">LinkedIn</a></span>
  <span><a href="https://www.github.com/wenzstev">GitHub</a></span>
  </div>
</footer>


    </div>
    </div>
  </body>
</html>
